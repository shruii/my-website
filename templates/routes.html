<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Details - ChargeRoute</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry"></script>
    <style>
        .station-card {
            transition: transform 0.2s;
        }
        .station-card:hover {
            transform: translateY(-2px);
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E0 #EDF2F7;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #EDF2F7;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #CBD5E0;
            border-radius: 4px;
        }
    </style>
    <script>
        let map;
        let currentMarkers = [];
        let currentRoute = null;
        let infoWindow;
        let directionsService;
        let directionsRenderer;
        
        function initMap() {
            const routes = {{ routes|tojson|safe }};
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: { lat: routes[0].points[0].lat, lng: routes[0].points[0].lng },
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: false,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                }
            });
            
            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#4285F4",
                    strokeWeight: 5
                }
            });

            // Show first route by default
            selectRoute(routes[0].id);
        }

        function selectRoute(routeId) {
            const routes = {{ routes|tojson|safe }};
            const route = routes.find(r => r.id === routeId);
            
            if (!route) return;
            
            // Update UI for selected route
            document.querySelectorAll('.route-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50');
                card.classList.add('border-gray-200');
            });
            
            const selectedCard = document.getElementById(`route-${routeId}`);
            if (selectedCard) {
                selectedCard.classList.remove('border-gray-200');
                selectedCard.classList.add('border-blue-500', 'bg-blue-50');
            }

            // Clear previous markers
            clearMarkers();
            
            // Display route
            displayRoute(route);
            
            // Fetch and display charging stations
            fetchStations(route.points);
            
            currentRoute = route;
        }

        function displayRoute(route) {
            const origin = `${route.points[0].lat},${route.points[0].lng}`;
            const destination = `${route.points[route.points.length-1].lat},${route.points[route.points.length-1].lng}`;
            
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                }
            });
        }

        function fetchStations(routePoints) {
            fetch('/get_stations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ route: routePoints })
            })
            .then(response => response.json())
            .then(data => {
                displayStations(data.stations);
            })
            .catch(error => console.error('Error:', error));
        }

        function displayStations(stations) {
            clearMarkers();
            
            stations.forEach(station => {
                const marker = new google.maps.Marker({
                    position: { lat: station.lat, lng: station.lng },
                    map: map,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/kml/shapes/gas_stations_maps.png',
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    title: station.name
                });

                marker.addListener('click', () => {
                    showStationDetails(station, marker);
                });

                currentMarkers.push(marker);
            });

            // Update stations list
            updateStationsList(stations);
        }

        function clearMarkers() {
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
        }

        function showStationDetails(station, marker) {
            // Update info window
            const content = `
                <div class="p-3 max-w-sm">
                    <h3 class="font-bold text-lg mb-2">${station.name}</h3>
                    <p class="text-gray-600 mb-2">${station.address}</p>
                    <p class="mb-2">Rating: ${station.rating} ⭐</p>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);

            // Fetch and display detailed information
            fetch(`/station_details/${station.id}`)
                .then(response => response.json())
                .then(details => {
                    displayDetailedStationInfo(details);
                })
                .catch(error => console.error('Error:', error));
        }

        function displayDetailedStationInfo(station) {
            const detailsContainer = document.getElementById('station-details');
            detailsContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-bold mb-4">${station.name}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-700">Address</h4>
                            <p>${station.address}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700">Contact</h4>
                            <p>${station.phone || 'Not available'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700">Rating</h4>
                            <p>${station.rating} / 5 (${station.user_ratings_total} reviews)</p>
                        </div>

                        ${station.opening_hours ? `
                            <div>
                                <h4 class="font-semibold text-gray-700">Opening Hours</h4>
                                <ul class="list-disc list-inside">
                                    ${station.opening_hours.map(hours => `<li>${hours}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-4 mt-6">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(station.name)}&query_place_id=${station.id}" 
                               target="_blank" 
                               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                Open in Google Maps
                            </a>
                            ${station.website ? `
                                <a href="${station.website}" 
                                   target="_blank" 
                                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    Visit Website
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStationsList(stations) {
            const listContainer = document.getElementById('stations-list');
            listContainer.innerHTML = stations.map(station => `
                <div class="station-card bg-white p-4 rounded-lg shadow-md hover:shadow-lg cursor-pointer"
                     onclick="showStationDetails(${JSON.stringify(station).replace(/"/g, '&quot;')}, null)">
                    <h4 class="font-bold text-lg mb-2">${station.name}</h4>
                    <p class="text-gray-600 text-sm mb-2">${station.address}</p>
                    <p class="text-sm">
                        <span class="font-semibold">Rating:</span> 
                        ${station.rating} ⭐ (${station.user_ratings_total} reviews)
                    </p>
                </div>
            `).join('');
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen" onload="initMap()">
    <!-- Header -->
    <header class="bg-white shadow-md py-4">
        <div class="container mx-auto flex justify-between items-center px-4">
            <h1 class="text-2xl font-bold text-blue-600">ChargeRoute</h1>
            <a href="/" class="text-blue-500 hover:text-blue-600">New Search</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <!-- Journey Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Journey Details</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <p class="text-gray-600">From</p>
                        <p class="font-semibold">{{ from_location }}</p>
                    </div>
                    <div>
                        <p class="text-gray-600">To</p>
                        <p class="font-semibold">{{ to_location }}</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Estimated Range</p>
                        <p class="font-semibold">{{ estimated_range }} km</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Routes -->
        <div class="mb-8">
            <h3 class="text-xl font-bold mb-4">Available Routes</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for route in routes %}
                <div id="route-{{ route.id }}" 
                     class="route-card bg-white p-4 rounded-lg shadow-md border-2 {% if loop.first %}border-blue-500 bg-blue-50{% else %}border-gray-200{% endif %} cursor-pointer hover:shadow-lg"
                     onclick="selectRoute('{{ route.id }}')">
                    <h4 class="font-bold text-lg mb-2">Route {{ loop.index }}</h4>
                    <div class="space-y-2">
                        <p class="text-gray-600">
                            <span class="font-semibold">Distance:</span> 
                            {{ route.distance_text }}
                        </p>
                        <p class="text-gray-600">
                            <span class="font-semibold">Duration:</span> 
                            {{ route.duration_text }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Map and Stations -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Map -->
            <div class="lg:col-span-2">
                <div id="map" class="w-full h-[600px] rounded-lg shadow-lg"></div>
            </div>

            <!-- Station Details -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Detailed Station Info -->
                <div id="station-details" class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-600 text-center">Select a charging station to view details</p>
                </div>

                <!-- Stations List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Charging Stations</h3>
                    <div id="stations-list" class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                        <!-- Stations will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 ChargeRoute. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>